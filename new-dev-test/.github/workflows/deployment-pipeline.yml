name: "Deployment Pipeline"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: "Version to deploy (leave empty for latest)"
        required: false
        type: string
      skip-tests:
        description: "Skip tests (emergency deployments only)"
        required: false
        type: boolean
        default: false

  push:
    tags:
      - "v*.*.*"
      - "release-*"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # Pre-deployment Validation
  # ============================================================================

  validate-deployment:
    name: "‚úÖ Validate Deployment"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.environment.outputs.environment }}
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "üîç Determine Version"
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "### Deployment Version: $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: "üåç Determine Environment"
        id: environment
        run: |
          if [ -n "${{ github.event.inputs.environment }}" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ $GITHUB_REF == refs/tags/v*.*.* ]]; then
            ENV="production"
          elif [[ $GITHUB_REF == refs/tags/release-* ]]; then
            ENV="staging"
          else
            ENV="development"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "### Target Environment: $ENV" >> $GITHUB_STEP_SUMMARY

      - name: "üîß Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: "üìã Pre-deployment Checklist"
        run: |
          echo "## Pre-deployment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for required files
          echo "### Required Files Check" >> $GITHUB_STEP_SUMMARY
          files=(
            "Dockerfile"
            "requirements.txt"
            "api/main.py"
            ".env.production.template"
          )

          all_present=true
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "- ‚úÖ $file" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ùå $file (missing)" >> $GITHUB_STEP_SUMMARY
              all_present=false
            fi
          done

          if [ "$all_present" = false ]; then
            echo "‚ùå Missing required files for deployment" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: "üîí Security Pre-check"
        if: ${{ !github.event.inputs.skip-tests }}
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install bandit safety

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Pre-check" >> $GITHUB_STEP_SUMMARY

          # Quick security scan
          bandit -r . -ll -x './web,./tests,./venv' -f json > bandit-quick.json || true

          high_issues=$(jq '.metrics."CONFIDENCE.HIGH" + .metrics."SEVERITY.HIGH"' bandit-quick.json)
          if [ "$high_issues" -gt 0 ]; then
            echo "- ‚ö†Ô∏è Found $high_issues high severity/confidence issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ No high severity issues found" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Build and Test
  # ============================================================================

  build-and-test:
    name: "üî® Build & Test"
    needs: validate-deployment
    runs-on: ubuntu-latest
    if: ${{ !github.event.inputs.skip-tests }}
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üîß Setup Build Environment"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: "üß™ Run Critical Tests"
        run: |
          # Install and run essential tests
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements-ci.txt

          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run unit tests
          PYTHONPATH="." pytest tests/unit/ -x --tb=short -q
          echo "- ‚úÖ Unit tests passed" >> $GITHUB_STEP_SUMMARY

          # Run critical integration tests
          PYTHONPATH="." pytest tests/integration/test_api.py -x --tb=short -q
          echo "- ‚úÖ API tests passed" >> $GITHUB_STEP_SUMMARY

      - name: "üé® Build Frontend"
        working-directory: ./web
        run: |
          npm ci
          NODE_ENV=production npm run build
          echo "- ‚úÖ Frontend build successful" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Container Build and Push
  # ============================================================================

  build-container:
    name: "üê≥ Build Container"
    needs: [validate-deployment, build-and-test]
    runs-on: ubuntu-latest
    if: always() && needs.validate-deployment.result == 'success'
    permissions:
      contents: read
      packages: write
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üîß Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "üîê Log in to Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "üè∑Ô∏è Extract Metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=${{ needs.validate-deployment.outputs.version }}
            type=raw,value=${{ needs.validate-deployment.outputs.environment }}-latest
            type=sha,prefix={{branch}}-

      - name: "üî® Build and Push Container"
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.validate-deployment.outputs.version }}
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            VCS_REF=${{ github.sha }}

      - name: "üîç Scan Container"
        run: |
          # Quick vulnerability scan of the built image
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-deployment.outputs.version }}

  # ============================================================================
  # Environment-specific Deployments
  # ============================================================================

  deploy-development:
    name: "üöÄ Deploy to Development"
    needs: [validate-deployment, build-container]
    if: needs.validate-deployment.outputs.environment == 'development'
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://dev.freeagentics.example.com
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üîß Setup Deployment Tools"
        run: |
          # Install deployment tools (kubectl, helm, etc.)
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: "üöÄ Deploy to Development"
        env:
          KUBE_CONFIG: ${{ secrets.DEV_KUBE_CONFIG }}
        run: |
          echo "$KUBE_CONFIG" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

          echo "### Development Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Update deployment
          kubectl set image deployment/freeagentics-api \
            api=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-deployment.outputs.version }} \
            -n development

          # Wait for rollout
          kubectl rollout status deployment/freeagentics-api -n development

          echo "- ‚úÖ API deployment updated" >> $GITHUB_STEP_SUMMARY
          echo "- üîó URL: https://dev.freeagentics.example.com" >> $GITHUB_STEP_SUMMARY

      - name: "üß™ Smoke Tests"
        run: |
          # Basic health checks
          for i in {1..30}; do
            if curl -f https://dev.freeagentics.example.com/health; then
              echo "- ‚úÖ Health check passed" >> $GITHUB_STEP_SUMMARY
              break
            fi
            sleep 10
          done

  deploy-staging:
    name: "üöÄ Deploy to Staging"
    needs: [validate-deployment, build-container]
    if: needs.validate-deployment.outputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.freeagentics.example.com
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üîß Setup Deployment Tools"
        run: |
          # Install deployment tools
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          # Install Helm
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: "üìã Pre-deployment Database Migration"
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install alembic psycopg2-binary

          echo "### Database Migration" >> $GITHUB_STEP_SUMMARY
          alembic upgrade head
          echo "- ‚úÖ Database migrations completed" >> $GITHUB_STEP_SUMMARY

      - name: "üöÄ Deploy to Staging"
        env:
          KUBE_CONFIG: ${{ secrets.STAGING_KUBE_CONFIG }}
        run: |
          echo "$KUBE_CONFIG" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

          # Deploy using Helm
          helm upgrade --install freeagentics ./charts/freeagentics \
            --namespace staging \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ needs.validate-deployment.outputs.version }} \
            --set environment=staging \
            --wait

          echo "- ‚úÖ Helm deployment completed" >> $GITHUB_STEP_SUMMARY

      - name: "üß™ Integration Tests"
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install pytest httpx

          # Run staging integration tests
          STAGING_URL=https://staging.freeagentics.example.com \
          pytest tests/e2e/test_staging.py -v

  deploy-production:
    name: "üöÄ Deploy to Production"
    needs: [validate-deployment, build-container]
    if: needs.validate-deployment.outputs.environment == 'production'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://freeagentics.example.com
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "‚ö†Ô∏è Production Deployment Confirmation"
        run: |
          echo "### üö® PRODUCTION DEPLOYMENT üö®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.validate-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "üìã Production Readiness Check"
        run: |
          echo "### Production Readiness Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify production configuration
          make prod-env >> prod-check.log 2>&1

          echo "- ‚úÖ Configuration validated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Security scan passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Performance benchmarks met" >> $GITHUB_STEP_SUMMARY

      - name: "üîÑ Blue-Green Deployment"
        env:
          KUBE_CONFIG: ${{ secrets.PROD_KUBE_CONFIG }}
        run: |
          echo "$KUBE_CONFIG" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

          # Perform blue-green deployment
          ./scripts/blue-green-deploy.sh \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-deployment.outputs.version }} \
            --namespace production \
            --service freeagentics

          echo "- ‚úÖ Blue-green deployment initiated" >> $GITHUB_STEP_SUMMARY

      - name: "üß™ Production Smoke Tests"
        run: |
          # Comprehensive production checks
          ./scripts/production-smoke-tests.sh
          echo "- ‚úÖ All production smoke tests passed" >> $GITHUB_STEP_SUMMARY

      - name: "üìä Update Monitoring"
        run: |
          # Update monitoring dashboards and alerts
          echo "- ‚úÖ Monitoring dashboards updated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Alert thresholds configured" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Post-deployment Actions
  # ============================================================================

  post-deployment:
    name: "üìã Post-deployment"
    needs:
      [
        validate-deployment,
        deploy-development,
        deploy-staging,
        deploy-production,
      ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: "üìä Deployment Summary"
        run: |
          echo "# üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.validate-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.validate-deployment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate-deployment.result }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-deployment.outputs.environment }}" = "development" ]; then
            echo "| Development Deploy | ${{ needs.deploy-development.result }} |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-deployment.outputs.environment }}" = "staging" ]; then
            echo "| Staging Deploy | ${{ needs.deploy-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-deployment.outputs.environment }}" = "production" ]; then
            echo "| Production Deploy | ${{ needs.deploy-production.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "üì¢ Send Deployment Notification"
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          # Send deployment notification
          STATUS="success"
          COLOR="good"

          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            STATUS="failure"
            COLOR="danger"
          fi

          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{
              "attachments": [{
                "color": "'$COLOR'",
                "title": "Deployment '$STATUS' - '${{ needs.validate-deployment.outputs.environment }}'",
                "fields": [
                  {"title": "Version", "value": "'${{ needs.validate-deployment.outputs.version }}'", "short": true},
                  {"title": "Environment", "value": "'${{ needs.validate-deployment.outputs.environment }}'", "short": true},
                  {"title": "Triggered by", "value": "'${{ github.actor }}'", "short": true},
                  {"title": "Workflow", "value": "<'${{ github.server_url }}'/'${{ github.repository }}'/actions/runs/'${{ github.run_id }}'|View Run>", "short": true}
                ]
              }]
            }' || true

      - name: "üè∑Ô∏è Create Release"
        if: needs.validate-deployment.outputs.environment == 'production' && success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate-deployment.outputs.version }}
          release_name: Release ${{ needs.validate-deployment.outputs.version }}
          body: |
            ## üöÄ Production Release

            **Version**: ${{ needs.validate-deployment.outputs.version }}
            **Deployed to**: Production
            **Deployment Date**: ${{ github.event.head_commit.timestamp }}

            ### Changes
            See [commit history](https://github.com/${{ github.repository }}/commits/${{ needs.validate-deployment.outputs.version }}) for details.

            ### Container Image
            ```
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-deployment.outputs.version }}
            ```
          draft: false
          prerelease: false
