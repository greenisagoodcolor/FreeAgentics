{"version":3,"sources":["/Users/matthewmoroney/builds/FreeAgentics/web/lib/prompt-templates.ts"],"sourcesContent":["import type { Agent, Message, KnowledgeEntry } from \"@/lib/types\";\n\nexport interface PromptTemplate {\n  systemPrompt: string;\n  userPromptPrefix?: string;\n  userPromptSuffix?: string;\n  maxHistoryMessages?: number;\n}\n\n// Helper function to replace template variables\nfunction replaceVariables(\n  text: string,\n  variables: Record<string, string>,\n): string {\n  return Object.entries(variables).reduce(\n    (result, [key, value]) =>\n      result.replace(new RegExp(`{{${key}}}`, \"g\"), value),\n    text,\n  );\n}\n\n// Format conversation history for inclusion in prompts\nexport function formatConversationHistory(\n  messages: Message[],\n  agents: Map<string, Agent>,\n  maxMessages = 10,\n): string {\n  // Take the most recent messages up to maxMessages\n  const recentMessages = messages.slice(-maxMessages);\n\n  return recentMessages\n    .map((msg) => {\n      const sender =\n        msg.senderId === \"user\"\n          ? \"User\"\n          : agents.get(msg.senderId)?.name || \"Unknown Agent\";\n\n      return `${sender}: ${msg.content}`;\n    })\n    .join(\"\\n\\n\");\n}\n\n// Format knowledge entries for inclusion in prompts\nexport function formatKnowledgeForPrompt(\n  entries: KnowledgeEntry[],\n  includeMetadata = false,\n): string {\n  if (!entries.length) return \"No relevant knowledge available.\";\n\n  return entries\n    .map((entry) => {\n      let formatted = `KNOWLEDGE ENTRY: ${entry.title}\\n${entry.content}`;\n\n      if (includeMetadata) {\n        formatted += `\\nTags: ${entry.tags.join(\", \")}`;\n        formatted += `\\nTimestamp: ${entry.timestamp.toISOString()}`;\n      }\n\n      return formatted;\n    })\n    .join(\"\\n\\n\");\n}\n\n// Add a function to format the participants list for the prompt\n\n// Format conversation participants for inclusion in prompts\nexport function formatParticipantsList(\n  agents: Map<string, Agent>,\n  currentAgentId: string,\n): string {\n  return Array.from(agents.values())\n    .map((agent) => {\n      const isCurrentAgent = agent.id === currentAgentId;\n      return `- ${agent.name}${isCurrentAgent ? \" (you)\" : \"\"}: ${agent.biography.split(\".\")[0]}.`;\n    })\n    .join(\"\\n\");\n}\n\n// Assemble a complete prompt from template and variables\nexport function assemblePrompt(\n  template: PromptTemplate,\n  variables: Record<string, string>,\n  conversationHistory: Message[],\n  agents: Map<string, Agent>,\n  relevantKnowledge?: KnowledgeEntry[],\n): { systemPrompt: string; userPrompt: string } {\n  // Replace variables in the system prompt\n  const systemPrompt = replaceVariables(template.systemPrompt, variables);\n\n  // Format conversation history\n  const historyText = formatConversationHistory(\n    conversationHistory,\n    agents,\n    template.maxHistoryMessages,\n  );\n\n  // Format knowledge if provided\n  const knowledgeText = relevantKnowledge\n    ? formatKnowledgeForPrompt(relevantKnowledge)\n    : \"\";\n\n  // Assemble user prompt with optional prefix and suffix\n  let userPrompt = \"\";\n\n  if (template.userPromptPrefix) {\n    userPrompt +=\n      replaceVariables(template.userPromptPrefix, variables) + \"\\n\\n\";\n  }\n\n  if (knowledgeText) {\n    userPrompt += \"RELEVANT KNOWLEDGE:\\n\" + knowledgeText + \"\\n\\n\";\n  }\n\n  userPrompt += \"CONVERSATION HISTORY:\\n\" + historyText;\n\n  if (template.userPromptSuffix) {\n    userPrompt +=\n      \"\\n\\n\" + replaceVariables(template.userPromptSuffix, variables);\n  }\n\n  return { systemPrompt, userPrompt };\n}\n\n// Define standard templates for different purposes\n\n// Template for agent responses in conversation\nexport const agentResponseTemplate: PromptTemplate = {\n  systemPrompt: `You are {{agentName}}, with the following biography: {{agentBiography}}\n\nYou are participating in a multi-agent conversation with the following participants:\n{{participantsList}}\n\nYour responses should be consistent with your character's knowledge, personality, and background.\nYou should respond naturally as if you are having a conversation with multiple participants.\n\nIMPORTANT: Always start your response with \"{{agentName}}:\" followed by your message.\n\nWhen a message is clearly directed at another agent (e.g., addressed by name), you should:\n1. Only respond if you have something valuable to add\n2. Acknowledge that the message was primarily for another agent\n3. Keep your response brief and relevant\n\nWhen a message is directed at you specifically, provide a complete and helpful response.\nWhen a message is directed at everyone or no one specific, respond naturally.\n\nYou have access to your own knowledge base which will be provided in the prompt if relevant.\nOnly reference knowledge that is explicitly provided to you.`,\n\n  userPromptSuffix: `Based on the conversation history and your knowledge, provide a response as {{agentName}}.\nYour response should be a single message in a conversational tone.\nRemember to start your response with \"{{agentName}}:\" followed by your message.\nIf the message was clearly directed at another agent and you don't have anything valuable to add, respond with \"SKIP_RESPONSE\" and I will not include your message.`,\n\n  maxHistoryMessages: 10,\n};\n\n// Template for extracting beliefs from conversations\nexport const beliefExtractionTemplate: PromptTemplate = {\n  systemPrompt: `You are an AI assistant that analyzes conversations and extracts potential new knowledge or beliefs.\nYour task is to identify information, facts, or beliefs that should be added to an agent's knowledge base.\nFocus on extracting factual information, preferences, opinions, and relationships mentioned in the conversation.\n\nIMPORTANT: Format your response using Obsidian-style markdown. Use [[double brackets]] around important concepts, entities, and categories that should be tagged.`,\n\n  userPromptPrefix: `The following is a conversation involving {{agentName}}.\nExtract potential new knowledge or beliefs that {{agentName}} should remember from this conversation.\nPay special attention to: {{extractionPriorities}}`,\n\n  userPromptSuffix: `List the extracted beliefs in bullet points. Each belief should be a concise statement of fact or opinion.\nFor each belief:\n1. Use [[double brackets]] around key concepts that should be tagged\n2. Indicate the confidence level (High/Medium/Low) based on how explicitly it was stated\n3. Format the belief as a complete, well-structured markdown note\n\nExample format:\n- {{agentName}} believes that [[quantum computing]] will revolutionize [[cryptography]] within the next decade. (High)\n- {{agentName}} seems to prefer [[coffee]] over [[tea]] based on their ordering habits. (Medium)`,\n\n  maxHistoryMessages: 20,\n};\n\n// Template for relationship analysis\nexport const relationshipAnalysisTemplate: PromptTemplate = {\n  systemPrompt: `You are an AI assistant that analyzes conversations to determine the relationship dynamics between participants.\nYour task is to assess how {{agentName}} relates to other participants in the conversation.`,\n\n  userPromptPrefix: `The following is a conversation involving {{agentName}} and other participants.\nAnalyze the conversation to determine {{agentName}}'s relationship with each other participant.`,\n\n  userPromptSuffix: `For each participant that {{agentName}} interacted with, provide:\n1. A sentiment score from -5 (very negative) to +5 (very positive)\n2. A brief description of the relationship dynamic\n3. Key moments in the conversation that support your analysis`,\n\n  maxHistoryMessages: 15,\n};\n"],"names":["agentResponseTemplate","assemblePrompt","beliefExtractionTemplate","formatConversationHistory","formatKnowledgeForPrompt","formatParticipantsList","relationshipAnalysisTemplate","replaceVariables","text","variables","Object","entries","reduce","result","key","value","replace","RegExp","messages","agents","maxMessages","recentMessages","slice","map","msg","sender","senderId","get","name","content","join","includeMetadata","length","entry","formatted","title","tags","timestamp","toISOString","currentAgentId","Array","from","values","agent","isCurrentAgent","id","biography","split","template","conversationHistory","relevantKnowledge","systemPrompt","historyText","maxHistoryMessages","knowledgeText","userPrompt","userPromptPrefix","userPromptSuffix"],"mappings":"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"}