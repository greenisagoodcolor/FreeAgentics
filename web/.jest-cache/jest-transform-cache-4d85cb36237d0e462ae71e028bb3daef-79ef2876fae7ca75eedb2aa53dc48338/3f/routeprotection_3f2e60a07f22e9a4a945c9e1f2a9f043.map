{"version":3,"sources":["/Users/matthewmoroney/builds/FreeAgentics/web/lib/auth/route-protection.tsx"],"sourcesContent":["\"use client\";\n\nimport { useCallback, useEffect, useState } from \"react\";\nimport { redirect } from \"next/navigation\";\nimport { getSessionId } from \"../session-management\";\n\n// User roles following ADR-011\nexport enum UserRole {\n  ADMIN = \"admin\",\n  DEVELOPER = \"developer\",\n  OBSERVER = \"observer\",\n  SERVICE = \"service\",\n}\n\n// User interface\nexport interface User {\n  id: string;\n  email: string;\n  name: string;\n  role: UserRole;\n  tenantId: string;\n  agentLimit: number;\n  coalitionLimit: number;\n  isActive: boolean;\n  lastLoginAt?: Date;\n}\n\n// Authentication state\nexport interface AuthState {\n  user: User | null;\n  isAuthenticated: boolean;\n  isLoading: boolean;\n  error: string | null;\n}\n\n// Permission definitions following ADR-011\nexport const PERMISSIONS = {\n  agent: {\n    create: [UserRole.ADMIN, UserRole.DEVELOPER],\n    read: [UserRole.ADMIN, UserRole.DEVELOPER, UserRole.OBSERVER],\n    update: [UserRole.ADMIN, UserRole.DEVELOPER],\n    delete: [UserRole.ADMIN],\n    export: [UserRole.ADMIN, UserRole.DEVELOPER],\n  },\n  coalition: {\n    create: [UserRole.ADMIN, UserRole.DEVELOPER],\n    read: [UserRole.ADMIN, UserRole.DEVELOPER, UserRole.OBSERVER],\n    update: [UserRole.ADMIN, UserRole.DEVELOPER],\n    delete: [UserRole.ADMIN],\n    business_data: [UserRole.ADMIN],\n  },\n  system: {\n    users: [UserRole.ADMIN],\n    metrics: [UserRole.ADMIN, UserRole.DEVELOPER],\n    logs: [UserRole.ADMIN],\n    backup: [UserRole.ADMIN],\n  },\n} as const;\n\n// Authentication client\nexport class AuthClient {\n  private baseUrl: string;\n  private user: User | null = null;\n\n  constructor(baseUrl: string = \"/api/auth\") {\n    this.baseUrl = baseUrl;\n  }\n\n  async getCurrentUser(): Promise<User | null> {\n    try {\n      const response = await fetch(`${this.baseUrl}/me`, {\n        method: \"GET\",\n        credentials: \"include\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n\n      if (response.status === 401) return null;\n      if (!response.ok) throw new Error(`HTTP ${response.status}`);\n\n      const data = await response.json();\n      this.user = data.user;\n      return this.user;\n    } catch (error) {\n      console.error(\"Failed to get current user:\", error);\n      return null;\n    }\n  }\n\n  hasPermission(\n    user: User | null,\n    resource: keyof typeof PERMISSIONS,\n    action: string,\n  ): boolean {\n    if (!user || !user.isActive) return false;\n    const resourcePermissions = PERMISSIONS[resource] as unknown as Record<\n      string,\n      UserRole[]\n    >;\n    const requiredRoles = resourcePermissions[action];\n    if (!requiredRoles) return false;\n    return requiredRoles.includes(user.role);\n  }\n}\n\nexport const authClient = new AuthClient();\n\n// Client-side authentication guard hook\nexport function useAuth() {\n  const [authState, setAuthState] = useState<AuthState>({\n    user: null,\n    isAuthenticated: false,\n    isLoading: true,\n    error: null,\n  });\n\n  const checkAuth = useCallback(async () => {\n    try {\n      setAuthState((prev) => ({ ...prev, isLoading: true, error: null }));\n      const user = await authClient.getCurrentUser();\n      setAuthState({\n        user,\n        isAuthenticated: !!user,\n        isLoading: false,\n        error: null,\n      });\n    } catch (error) {\n      setAuthState({\n        user: null,\n        isAuthenticated: false,\n        isLoading: false,\n        error: error instanceof Error ? error.message : \"Authentication failed\",\n      });\n    }\n  }, []);\n\n  const hasPermission = useCallback(\n    (resource: keyof typeof PERMISSIONS, action: string) => {\n      return authClient.hasPermission(authState.user, resource, action);\n    },\n    [authState.user],\n  );\n\n  useEffect(() => {\n    checkAuth();\n  }, [checkAuth]);\n\n  return { ...authState, hasPermission };\n}\n\n// Route protection guard for pages\nexport async function requireAuth(requiredRoles?: UserRole[]): Promise<User> {\n  const sessionId = getSessionId(\"auth\");\n  if (!sessionId) redirect(\"/login\");\n\n  try {\n    const response = await fetch(\"/api/auth/validate\", {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ sessionId }),\n    });\n\n    if (!response.ok) redirect(\"/login\");\n\n    const data = await response.json();\n    const user = data.user;\n\n    if (!user || !user.isActive) redirect(\"/login\");\n    if (requiredRoles && !requiredRoles.includes(user.role))\n      redirect(\"/unauthorized\");\n\n    return user;\n  } catch {\n    redirect(\"/login\");\n  }\n}\n\n// Permission-based component wrapper\ninterface RequirePermissionProps {\n  resource: keyof typeof PERMISSIONS;\n  action: string;\n  children: React.ReactNode;\n  fallback?: React.ReactNode;\n}\n\nexport function RequirePermission({\n  resource,\n  action,\n  children,\n  fallback = null,\n}: RequirePermissionProps) {\n  const { hasPermission } = useAuth();\n  return hasPermission(resource, action) ? <>{children}</> : <>{fallback}</>;\n}\n"],"names":["AuthClient","PERMISSIONS","RequirePermission","authClient","requireAuth","useAuth","UserRole","agent","create","read","update","delete","export","coalition","business_data","system","users","metrics","logs","backup","constructor","baseUrl","user","getCurrentUser","response","fetch","method","credentials","headers","status","ok","Error","data","json","error","console","hasPermission","resource","action","isActive","resourcePermissions","requiredRoles","includes","role","authState","setAuthState","useState","isAuthenticated","isLoading","checkAuth","useCallback","prev","message","useEffect","sessionId","getSessionId","redirect","body","JSON","stringify","children","fallback"],"mappings":"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"}