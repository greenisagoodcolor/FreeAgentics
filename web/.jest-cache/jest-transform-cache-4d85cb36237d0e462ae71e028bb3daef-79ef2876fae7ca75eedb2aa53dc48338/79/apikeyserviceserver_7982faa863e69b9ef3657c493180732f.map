{"version":3,"names":["deleteApiKey","cov_27spzoys17","f","s","retrieveApiKey","storeApiKey","ENCRYPTION_KEY","process","env","b","Error","encrypt","text","iv","_crypto","default","randomBytes","cipher","createCipheriv","Buffer","from","encrypted","update","concat","final","toString","decrypt","parts","split","shift","encryptedText","join","decipher","createDecipheriv","decrypted","provider","apiKey","sessionId","randomUUID","encryptedApiKey","cookieStore","_headers","cookies","set","httpOnly","secure","NODE_ENV","sameSite","maxAge","console","log","error","get","value","decryptedKey","delete"],"sources":["/Users/matthewmoroney/builds/FreeAgentics/web/lib/api-key-service-server.ts"],"sourcesContent":["// lib/api-key-service-server.ts\n// Server-side API key storage using cookies instead of sessionStorage\n\nimport { cookies } from \"next/headers\";\nimport crypto from \"crypto\";\n\n// Ensure ENCRYPTION_KEY is available\nconst ENCRYPTION_KEY = process.env.ENCRYPTION_KEY;\nif (!ENCRYPTION_KEY) {\n  throw new Error(\"ENCRYPTION_KEY environment variable is not set\");\n}\n\nfunction encrypt(text: string): string {\n  const iv = crypto.randomBytes(16);\n  const cipher = crypto.createCipheriv(\n    \"aes-256-cbc\",\n    Buffer.from(ENCRYPTION_KEY, \"hex\"),\n    iv,\n  );\n  let encrypted = cipher.update(text);\n  encrypted = Buffer.concat([encrypted, cipher.final()]);\n  return iv.toString(\"hex\") + \":\" + encrypted.toString(\"hex\");\n}\n\nfunction decrypt(text: string): string {\n  const parts = text.split(\":\");\n  const iv = Buffer.from(parts.shift()!, \"hex\");\n  const encryptedText = Buffer.from(parts.join(\":\"), \"hex\");\n  const decipher = crypto.createDecipheriv(\n    \"aes-256-cbc\",\n    Buffer.from(ENCRYPTION_KEY, \"hex\"),\n    iv,\n  );\n  let decrypted = decipher.update(encryptedText);\n  decrypted = Buffer.concat([decrypted, decipher.final()]);\n  return decrypted.toString();\n}\n\nexport async function storeApiKey(\n  provider: string,\n  apiKey: string,\n): Promise<string> {\n  try {\n    const sessionId = crypto.randomUUID();\n    const encryptedApiKey = encrypt(apiKey);\n\n    const cookieStore = await cookies();\n    cookieStore.set(`api_key_${provider}_${sessionId}`, encryptedApiKey, {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === \"production\",\n      sameSite: \"strict\",\n      maxAge: 60 * 60 * 24, // 24 hours\n    });\n\n    console.log(\n      `[API-KEY-SERVICE] API key stored with session ID: ${sessionId}`,\n    );\n    return sessionId;\n  } catch (error) {\n    console.error(\"[API-KEY-SERVICE] Error storing API key:\", error);\n    throw new Error(\"Failed to store API key securely\");\n  }\n}\n\nexport async function retrieveApiKey(\n  provider: string,\n  sessionId: string,\n): Promise<string | null> {\n  try {\n    const cookieStore = await cookies();\n    const encryptedApiKey = cookieStore.get(\n      `api_key_${provider}_${sessionId}`,\n    )?.value;\n\n    if (!encryptedApiKey) {\n      console.log(\n        `[API-KEY-SERVICE] No API key found for provider: ${provider}, session: ${sessionId}`,\n      );\n      return null;\n    }\n\n    const decryptedKey = decrypt(encryptedApiKey);\n    console.log(\n      `[API-KEY-SERVICE] Retrieved API key for provider: ${provider}`,\n    );\n    return decryptedKey;\n  } catch (error) {\n    console.error(\"[API-KEY-SERVICE] Error retrieving API key:\", error);\n    return null;\n  }\n}\n\nexport async function deleteApiKey(\n  provider: string,\n  sessionId: string,\n): Promise<void> {\n  try {\n    const cookieStore = await cookies();\n    cookieStore.delete(`api_key_${provider}_${sessionId}`);\n    console.log(`[API-KEY-SERVICE] Deleted API key for session: ${sessionId}`);\n  } catch (error) {\n    console.error(\"[API-KEY-SERVICE] Error deleting API key:\", error);\n  }\n}\n"],"mappings":"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","ignoreList":[]}